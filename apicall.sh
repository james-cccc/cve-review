#!/bin/bash
# Shell script to cross reference xray results to changelogs

#CVELIST=$(cat $REPORT | jq -r '.data[] | .component_versions.more_details.cves[] | .cve' | awk '!seen[$0]++' )
CVELIST=$(cat ./cve_list.txt )

# Create output directory
if [ ! -d "./output/reports/{rhsda,bugzilla}" ] 
then
    mkdir -p ./output/reports/{rhsda,bugzilla}
fi

# Create new files (in case you rerun)
echo > ./output/overview.txt
echo > ./output/open.txt
echo > ./output/closed.txt
echo "CVE, Bugzilla ID, URL, Status, Resolution, Severity, Description, Statement" > ./output/overview.csv
echo "CVE, Bugzilla ID, URL, Status, Resolution, Severity, Description, Statement" > ./output/open.csv
echo "CVE, Bugzilla ID, URL, Status, Resolution, Severity, Description, Statement" > ./output/closed.csv

for CVE in $CVELIST
do
    curl -s https://access.redhat.com/hydra/rest/securitydata/cve/$CVE.json | jq '.' > ./output/reports/rhsda/$CVE.json
    ID=$(jq -r '.bugzilla.id' ./output/reports/rhsda/$CVE.json)
    URL=$(jq -r '.bugzilla.url' ./output/reports/rhsda/$CVE.json)
    DESCRIPTION=$(jq -r '.bugzilla.description' ./output/reports/rhsda/$CVE.json)
    STATEMENT=$(jq -r '.statement' ./output/reports/rhsda/$CVE.json)

    curl -s https://bugzilla.redhat.com/rest/bug/$ID | jq '.' > ./output/reports/bugzilla/$CVE.json
    STATUS=$(jq -r '.bugs[].status' ./output/reports/bugzilla/$CVE.json)
    SEVERITY=$(jq -r '.bugs[].severity' ./output/reports/bugzilla/$CVE.json)
    RESOLUTION=$(jq -r '.bugs[].resolution' ./output/reports/bugzilla/$CVE.json)

    echo "CVE:             "$CVE >> ./output/overview.txt
    echo "Bugzilla ID:     "$ID >> ./output/overview.txt
    echo "URL:             "$URL >> ./output/overview.txt
    echo "Status:          "$STATUS >> ./output/overview.txt
    echo "Resolution:      "$RESOLUTION >> ./output/overview.txt
    echo "Severity:        "$SEVERITY >> ./output/overview.txt
    echo "Description:     "$DESCRIPTION >> ./output/overview.txt
    echo "Statement:       "$STATEMENT >> ./output/overview.txt
    echo >> ./output/overview.txt
    echo $CVE, $ID, $URL, $STATUS, $RESOLUTION, $SEVERITY, '"'$DESCRIPTION'"', '"'$STATEMENT'"' >> ./output/overview.csv

if [ "$STATUS" == "CLOSED" ]; then
    echo "CVE:             "$CVE >> ./output/closed.txt
    echo "Bugzilla ID:     "$ID >> ./output/closed.txt
    echo "URL:             "$URL >> ./output/closed.txt
    echo "Status:          "$STATUS >> ./output/closed.txt
    echo "Resolution:      "$RESOLUTION >> ./output/closed.txt
    echo "Severity:        "$SEVERITY >> ./output/closed.txt
    echo "Description:     "$DESCRIPTION >> ./output/closed.txt
    echo "Statement:       "$STATEMENT >> ./output/closed.txt
    echo >> ./output/closed.txt
    echo $CVE, $ID, $URL, $STATUS, $RESOLUTION, $SEVERITY, '"'$DESCRIPTION'"', '"'$STATEMENT'"' >> ./output/closed.csv
else
    echo "CVE:             "$CVE >> ./output/open.txt
    echo "Bugzilla ID:     "$ID >> ./output/open.txt
    echo "URL:             "$URL >> ./output/open.txt
    echo "Status:          "$STATUS >> ./output/open.txt
    echo "Resolution:      "$RESOLUTION >> ./output/open.txt
    echo "Severity:        "$SEVERITY >> ./output/open.txt
    echo "Description:     "$DESCRIPTION >> ./output/open.txt
    echo "Statement:       "$STATEMENT >> ./output/open.txt
    echo >> ./output/open.txt
    echo $CVE, $ID, $URL, $STATUS, $RESOLUTION, $SEVERITY, '"'$DESCRIPTION'"', '"'$STATEMENT'"' >> ./output/open.csv
fi

done
