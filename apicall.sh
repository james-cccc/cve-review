#!/bin/bash
# Shell script to cross reference xray results to changelogs

CVELIST=$(cat /home/centos/cve-review/cves.txt)
IMAGE=4.4.4-jenkins
#CVELIST=$(cat $REPORT | jq -r '.data[] | .component_versions.more_details.cves[] | .cve' | awk '!seen[$0]++' )

# Create output directory
if [ ! -d "./$/reports/{review,bugzilla}" ] 
then
    mkdir -p ./$IMAGE/reports/{review,bugzilla}
fi

echo > ./$IMAGE/overview.txt

for CVE in $CVELIST
do
    curl -s https://access.redhat.com/hydra/rest/securitydata/cve/$CVE.json | jq '.' > ./$IMAGE/reports/review/$CVE.json
    ID=$(jq -r '.bugzilla.id' ./$IMAGE/reports/review/$CVE.json)
    URL=$(jq -r '.bugzilla.url' ./$IMAGE/reports/review/$CVE.json)
    DESCRIPTION=$(jq -r '.bugzilla.description' ./$IMAGE/reports/review/$CVE.json)

    curl -s https://bugzilla.redhat.com/rest/bug/$ID | jq '.' > ./$IMAGE/reports/bugzilla/$CVE.json
    STATUS=$(jq -r '.bugs[].status' ./$IMAGE/reports/bugzilla/$CVE.json)
    SEVERITY=$(jq -r '.bugs[].severity' ./$IMAGE/reports/bugzilla/$CVE.json)

#    ADDRESSED=$(curl -s https://bugzilla.redhat.com/rest/bug/$ID/comment | jq '.bugs[].comments[].text' | grep -i "This issue has been addressed in the following products:" | grep -i "Openshift")
#    FIXED=$(curl -s https://bugzilla.redhat.com/rest/bug/$ID/comment | jq '.bugs[].comments[].text' | grep -i "Fixed in OpenShift")
    RHSA=$( echo $ADDRESSED | grep RHSA)

    echo "CVE:         "$CVE >> ./$IMAGE/overview.txt
    echo "Bugzilla ID: "$ID >> ./$IMAGE/overview.txt
    echo "URL:         "$URL >> ./$IMAGE/overview.txt
    echo "Status:      "$STATUS >> ./$IMAGE/overview.txt
    echo "Severity:    "$SEVERITY >> ./$IMAGE/overview.txt
    echo "Description: "$DESCRIPTION >> ./$IMAGE/overview.txt
#    echo "OCP related: "
    echo >> ./$IMAGE/overview.txt

done

    #    if [ -n "$ADDRESSED" ]; then STATE=Addressed; fi;
#    if [ -n "$FIXED" ]; then STATE=Fixed; fi; 
#    echo $STATE >> ./$IMAGE/overview.txt
#    echo $RHSA >> ./$IMAGE/overview.txt
#     echo $(curl -s https://bugzilla.redhat.com/rest/bug/$ID/comment | jq . | grep -i "This issue has been addressed in the following products:" | grep -i "Openshift") >> ./$/overview.txt
#     echo $(jq -r '.package_state[] | select(.cpe | startswith("cpe:/a:redhat:openshift:4"))' ./$/reports/review/$CVE.json) >> ./$IMAGE/overview.txt
#     echo $(jq -r '.affected_release[] | select(.cpe | startswith("cpe:/a:redhat:openshift:4"))' ./$/reports/review/$CVE.json) >> ./$IMAGE/overview.txt
