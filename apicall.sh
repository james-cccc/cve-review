#!/bin/bash
# Shell script to cross reference xray results to changelogs

CVELIST=$(cat ./cves.txt)
#CVELIST=$(cat $REPORT | jq -r '.data[] | .component_versions.more_details.cves[] | .cve' | awk '!seen[$0]++' )

# Create output directory
if [ ! -d "./output/reports/{review,bugzilla}" ] 
then
    mkdir -p ./output/reports/{review,bugzilla}
fi

echo > ./output/overview.txt

for CVE in $CVELIST
do
    curl -s https://access.redhat.com/hydra/rest/securitydata/cve/$CVE.json | jq '.' > ./output/reports/review/$CVE.json
    ID=$(jq -r '.bugzilla.id' ./output/reports/review/$CVE.json)
    URL=$(jq -r '.bugzilla.url' ./output/reports/review/$CVE.json)
    DESCRIPTION=$(jq -r '.bugzilla.description' ./output/reports/review/$CVE.json)
    STATEMENT=$(jq -r '.statement' ./output/reports/review/$CVE.json)

    curl -s https://bugzilla.redhat.com/rest/bug/$ID | jq '.' > ./output/reports/bugzilla/$CVE.json
    STATUS=$(jq -r '.bugs[].status' ./output/reports/bugzilla/$CVE.json)
    SEVERITY=$(jq -r '.bugs[].severity' ./output/reports/bugzilla/$CVE.json)
    RESOLUTION=$(jq -r '.bugs[].resolution' ./output/reports/bugzilla/$CVE.json)

    echo "CVE:             "$CVE >> ./output/overview.txt
    echo "Bugzilla ID:     "$ID >> ./output/overview.txt
    echo "URL:             "$URL >> ./output/overview.txt
    echo "Status:          "$STATUS >> ./output/overview.txt
    echo "Resolution:      "$RESOLUTION >> ./output/overview.txt
    echo "Severity:        "$SEVERITY >> ./output/overview.txt
    echo "Description:     "$DESCRIPTION >> ./output/overview.txt
    echo "Statement:       "$STATEMENT >> ./output/overview.txt

    echo >> ./output/overview.txt

done
