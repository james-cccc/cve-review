#!/bin/bash
# Shell script to cross reference xray results to changelogs

CVELIST=$(cat /home/centos/cve-review/cves.txt)
PACKAGE=4.4.4-jenkins
#REPORT=./example.json
#CVELIST=$(cat $REPORT | jq -r '.data[] | .component_versions.more_details.cves[] | .cve')

# Create output directory
if [ ! -d "/tmp/$PACKAGE/reports/resolved" ] 
then
    mkdir -p /tmp/$PACKAGE/reports/resolved
fi
if [ ! -d "/tmp/$PACKAGE/reports/review" ] 
then
    mkdir -p /tmp/$PACKAGE/reports/review
fi


# CVEs Found
echo > /tmp/$PACKAGE/overview.txt
echo "###################################################" >> /tmp/$PACKAGE/overview.txt
echo "# The following CVEs were found in the changelogs" >> /tmp/$PACKAGE/overview.txt
echo "###################################################" >> /tmp/$PACKAGE/overview.txt
for CVE in $CVELIST
do
if grep -qi $CVE /tmp/$PACKAGE/changelogs/*; then
    echo $CVE >> /tmp/$PACKAGE/overview.txt
    grep $CVE /tmp/$PACKAGE/changelogs/* >> /tmp/$PACKAGE/overview.txt
    curl -s https://access.redhat.com/hydra/rest/securitydata/cve/$CVE.json | jq '.' >> /tmp/$PACKAGE/reports/resolved/$CVE.json
fi
done


# CVEs Not Found
echo >> /tmp/$PACKAGE/overview.txt
echo "#####################################################" >> /tmp/$PACKAGE/overview.txt
echo "#The following CVEs should not relate to Openshift" >> /tmp/$PACKAGE/overview.txt
echo "#####################################################" >> /tmp/$PACKAGE/overview.txt
for CVE in $CVELIST
do
if grep -qi $CVE /tmp/$PACKAGE/changelogs/*; then
   :
else
    curl -s https://access.redhat.com/hydra/rest/securitydata/cve/$CVE.json | jq '.' > /tmp/$PACKAGE/reports/review/$CVE.json
if [[ $(jq '.package_state[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json) || $(jq '.affected_release[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json)   ]]; then
   :
else
    echo $CVE >> /tmp/$PACKAGE/overview.txt
    echo $( jq '.bugzilla' /tmp/$PACKAGE/reports/review/$CVE.json) >> /tmp/$PACKAGE/overview.txt
    echo $(jq '.package_state[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json) >> /tmp/$PACKAGE/overview.txt
fi
fi
done


# CVEs Not Found
echo >> /tmp/$PACKAGE/overview.txt
echo "#####################################################################################" >> /tmp/$PACKAGE/overview.txt
echo "#The following CVEs were not found in the changelogs and look to relate to Openshift" >> /tmp/$PACKAGE/overview.txt
echo "#####################################################################################" >> /tmp/$PACKAGE/overview.txt
for CVE in $CVELIST
do
if grep -qi $CVE /tmp/$PACKAGE/changelogs/*; then
   : 
else
if [[ $(jq '.package_state[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json) || $(jq '.affected_release[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json)   ]]; then
    echo $CVE >> /tmp/$PACKAGE/overview.txt
    echo $(jq '.bugzilla' /tmp/$PACKAGE/reports/review/$CVE.json) >> /tmp/$PACKAGE/overview.txt 
    echo $(jq '.package_state[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json) >> /tmp/$PACKAGE/overview.txt
    echo $(jq '.affected_release[] | select(.cpe == "cpe:/a:redhat:openshift:4")' /tmp/$PACKAGE/reports/review/$CVE.json) >> /tmp/$PACKAGE/overview.txt
    echo >> /tmp/$PACKAGE/overview.txt
fi
fi
done
