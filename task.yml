---
- name: Create output directories
  file:
    path: /tmp/{{ container_image }}/changelogs
    state: directory
    mode: 0775

- name: Pull the image
  podman_image:
    name: '{{ image_registry }}{{ container_image }}'

- name: Start container
  command: podman run -d '{{ image_registry }}{{ container_image }}'
  register: containerid
- debug: msg="{{containerid.stdout}}"

- name: Mount container
  command: podman mount '{{ containerid.stdout }}'
  register: mountid
- debug: msg="{{mountid.stdout}}"

- name: RPM query
  command: rpm -qa --root={{ mountid.stdout }}
  register: rpmout
- debug: msg="{{rpmout.stdout}}"

- name: Create rpm list
  copy:
    content: '{{ rpmout.stdout }}'
    dest: /tmp/{{ container_image }}/rpmlist.txt

- name: Create changelog for each package
  shell: rpm -q --root={{ mountid.stdout }} --changelog {{ item }} > /tmp/{{ container_image }}/changelogs/{{ item }}
  with_lines: cat /tmp/{{ container_image }}/rpmlist.txt

- name: Stop container
  command: podman stop {{ containerid.stdout }}

- name: Unmount container
  command: podman umount '{{ containerid.stdout }}'
  register: mountid
